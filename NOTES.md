# Workspace Notes (Snellman Replay)

- Repo rule: use Bazel (workspace: `/Users/kevin/projects/tm_server/server`). Avoid `go test`.

- Fixture corpus (certification):
  - Snellman ledger fixtures: `server/internal/replay/testdata/snellman_batch/` (S67-S69, G1-G7 = 21 games).
  - Additional batch: `server/internal/replay/testdata/snellman_batch_s64_66/` (S64-S66, G1-G7 = 21 games).
  - Expected totals oracle: `server/internal/replay/testdata/snellman_batch/manifest.json`.
  - Batch test: `server/internal/replay/snellman_batch_replay_test.go` runs `ImportText(...,"snellman") -> StartReplay -> JumpTo(end)` and asserts `state.FinalScoring[*].TotalVP`.
  - Dropout policy: fixtures containing `dropped from the game` are skipped in batch/final-score and ledger resource-matching tests (`snellman_batch_s64_66_replay_test.go`, `snellman_ledger_resources_test.go`).
  - Fetcher: `scripts/fetch_snellman_batch.py --output-dir ... --seasons 64,65,66` writes fixture `.txt` and `manifest.json`.

- Cleanup timing (critical): Snellman logs can contain late reactions after the final `PASS` of a round (leeches, Cultists `+TRACK`, etc.). Cleanup runs at the round boundary (processing the next `RoundStartItem`), not immediately at `AllPlayersPassed()`. See `server/internal/replay/simulator.go`.
  - End-of-log replay fallback: when `JumpTo(end)` lands in `PhaseAction` on round 6, force cleanup/final scoring even if `AllPlayersPassed()` is false (dropped-player logs can omit explicit final `PASS` for the dropped faction).

- Snellman ledger interpretation:
  - Each action row includes the player’s post-action totals (VP/resources/power bowls/cults).
  - Trailing leech markers like `3 1` on an action row indicate later leech/decline rows tied to that action (use these to bind `L`/`DL` to the correct source event).

- Leech semantics (Snellman parity + engine correctness):
  - `PowerLeechOffer.Amount` is the offered amount (adjacent building power sum) and is not capped by current Bowl I/II capacity. Capacity limits the actual gained power at acceptance time (`ResourcePool.AcceptPowerLeech`).
  - Snellman can log `Leech N from X` where the deltas show only `k < N` power gained and `k-1` VP lost.
  - Snellman can also include `Leech ...` rows when Bowl I+II are empty. Replay treats this as an automatic decline/no-op when no offer is pending (see `notation.LogAcceptLeechAction.Execute`).
  - Cultists leech-bonus tracking must be per event, not per source player: offers carry an `EventID` and Cultists pending bonuses are keyed by `EventID` (`server/internal/game/state.go`, `server/internal/game/action_power_leech.go`, `server/internal/game/resources.go`).

- Income-phase ordering (Snellman quirks):
  - Snellman can include actions between income blocks (pre-income interlude) and actions embedded inside income rows (post-income embedded action).
  - Converter tags these as `@<token>` (pre-income) and `^<token>` (post-income). See `server/internal/notation/snellman_to_concise.go`, `server/internal/notation/parser.go`, `server/internal/replay/simulator.go`.

- Converter gotchas (`server/internal/notation/snellman_to_concise.go`):
  - Terrain spelling: accept both `gray` and `grey`.
  - Trim whitespace before `+TRACK` parsing.
  - Preserve `connect rNN` prefixes so `+TW*` segments are not dropped.
  - Preserve intra-row ordering around conversions vs favor/town tokens (some rows rely on “convert before towns” or “convert before/after favor” to avoid priest-cap divergence).
  - Replay conversion now normalizes compound tokens so `L`/`DL` are always standalone actions (never chained with other actions), and leading Cultists `+TRACK` bumps are backtracked/chained to the prior triggering Cultists main action.
  - Replay-linear conversion (`ConvertSnellmanToConciseForReplay`) currently backtracks/chains leading Cultists `+TRACK` bumps to prior triggering main actions (same as display conversion).
  - For `action BON1` rows with conversion(s) before `build` (e.g. `action BON1. convert ... . build E8`), do not emit `ACTS-<coord>.<coord>`. Emit `ACT-BON-SPD` and keep conversions/build explicit (`ACT-BON-SPD.C... .E8`) so replay order remains BON1 -> conversions -> build and avoids non-idempotent special-action retries (`special action 8 already used this round`).
  - Batch validation on Snellman fixtures `S64-S69` (`server/internal/replay/testdata/snellman_batch*`) currently reports:
    - no chained leech tokens (`.L`, `.DL`, `L.`, `DL.`)
    - no standalone Cultists bump tokens (`+E/+W/+F/+A`) in Cultists column

- Status (current):
  - `bazel --batch test //internal/replay:replay_test --test_output=errors` is failing at `S67_G5` (`cannot afford upgrade to Temple`) with current backtracked Cultists bump behavior.
  - Ledger tests were updated to treat Cultists Snellman row-by-row state as non-authoritative for alignment/state checks (Cultists +TRACK timing can be backfilled in Snellman but applied immediately in replay).
  - In `S67_G5`, first observable Cultists resource drift appears around Snellman lines `81-84`:
    - line 81 (`action ACT5. build G4`) Snellman has `PW=4/5/3`, cult `1/0/2/2`
    - line 84 (`+AIR`) Snellman then moves to `PW=3/6/3`, cult `1/0/2/3`
    - current replay concise backtracks this as `ACT5.G4.+A`, applying the bowl/cult change at line 81 timing.
  - Separate root cause for the later `S67_G5` Temple affordability failure:
    - Snellman line `240` (`+EARTH` after `pass BON2` leech acceptance at lines `238-239`) is not present as a chained bump on the replay concise `PASS-BON-4C` token.
    - Missing this Cultists bump leaves Cultists at Earth `4` instead of `5` at Round 5 income start, which under-awards cult income by `1C` (line `245`), propagating to `3C` (not `4C`) before line `282`.
    - At line `282`, replay executes `C1PW:1C` to reach `4C`, then fails `UP-TE-F3` (`cannot afford upgrade to Temple`); expected was `5C` after conversion.
  - Converter fix for dropped Cultists bumps:
    - `appendCultBonus` now tries secondary target rows when the preferred row already contains the same `+TRACK` token, instead of returning early and dropping the bump.
    - If all candidate rows already include that bump, it appends to the first valid candidate (preserves multiple same-track bumps rather than dedup-dropping them).
    - This unblocks `S67_G5` replay and preserves replay notation tests (`//internal/notation:notation_test`) and replay suite (`//internal/replay:replay_test`).
  - Full server test verification (unfiltered):
    - `bazel --batch test //... --test_output=errors` passed on 2026-02-20.
  - Regression check after BON1 conversion-order fix:
    - `TestSnellmanBatchReplayS64to66_FinalScoresMatch` passes (no S64-S66 final-score regression).
    - S64-S66 ledger subset (`S66_G1`, `S66_G2`, `S64_G4`, `S64_G5`, `S64_G6`, `S65_G4`) has no `special action 8` errors and now passes under the Cultists-row-timing tolerance.
  - S65 Darklings final VP mismatches are fixed:
    - `4pLeague_S65_D1L1_G2`
    - `4pLeague_S65_D1L1_G3`
    - `4pLeague_S65_D1L1_G4`
  - Fix details: for Snellman `action BON1. dig N. build <coord>`, converter now emits `ACT-BON-SPD.DIGN-<coord>.<coord>` and replay supports `ACT-BON-SPD` as a pending free spade marker, so explicit paid digs (including Darklings priest/+2VP semantics) are preserved.

- UI gotcha (prod): Tailwind utilities may not apply in production (CSS shipped with unexpanded `@tailwind ...` directives), so layout-critical UI (e.g. the top Player Summary Bar) should use plain CSS/inline styles rather than Tailwind classes for `display:flex/grid`, sizing, and borders.

- Replay "Log" viewer (client):
  - `client/src/components/ReplayLog.tsx` renders `logStrings` as an HTML `<table>` by splitting each line on `|`. It does not display the literal pipes or fixed-width spacing from the concise text format.
  - Cells are fixed width (`6rem`) with `overflow:hidden` + `textOverflow:ellipsis`, so long tokens can be visually truncated even though the underlying `logStrings` line is intact.
  - `ReplayLog` row/cell click lookup now scans all `logLocations` (no early break on `lineIndex`) because server-side leech re-anchoring can produce non-monotonic `lineIndex` ordering by action index.

- Concise log generation:
  - `server/internal/notation/GenerateConciseLog` now keeps `L`/`DL` display tokens but reorders leech cells using `FromPlayerID` anchors so each leech’s previous non-leech token matches its true source action.
  - Regression test added: `server/internal/notation/generator_leech_placement_test.go` (distinct source leeches by same reacting player).
  - Replay import has an opt-in execution reorder for Snellman logs: `ReplayManager.SetSourceAnchoredLeechOrdering(true)` moves source-tagged `L`/`DL` actions directly after their triggering source action during parsing (`server/internal/replay/manager.go`). This is enabled in `server/cmd/server/main.go` for viewer sequencing, but defaults to `false` for strict ledger-parity/test flows.

- Player Summary Bar (client):
  - Rendered via `client/src/components/GameBoard/PlayerSummaryBar.tsx` and placed as a `react-grid-layout` tile `i: "summary"` with default `h=2`.
  - To make player cards fill the tile height, the summary bar uses a single-row CSS grid with `gridTemplateRows: "1fr"` and game/replay wrappers avoid Tailwind `flex-1` sizing and use inline flex styles instead.
  - Power bowls use `PowerCircleIcon` (purple circle) instead of the string label `PW`.

- 2026-02-20 replay update (S60-S63 batch):
  - Added fixture batch `server/internal/replay/testdata/snellman_batch_s60_63/` (28 games) and batch replay test `server/internal/replay/snellman_batch_s60_63_replay_test.go`.
  - Added ACTG conversion fallback for `action ACTG. build <coord>` in `server/internal/notation/snellman_to_concise.go` and regression coverage in `server/internal/notation/snellman_to_concise_test.go`.
  - Fixed Giants terraform charging bug in `server/internal/game/actions.go`: when remaining required spades are `0`, replay must not charge terraform costs (previously charged due Giants-special `GetTerraformCost` behavior).
  - Fixed Dwarves/Fakirs skip-cost dedup scope in `server/internal/game/actions.go`: de-dup skip payment only while `SuppressTurnAdvance` is true (compound/synthetic execution), so standalone later turns pay tunneling/carpet costs again.
  - Fixed `S63_G2` final-VP drift by preserving Snellman negative cult-step tokens in compounds (e.g. `-water. +TW5`):
    - converter now emits `-W` (`server/internal/notation/snellman_to_concise.go`)
    - parser/executor now supports `-F/-W/-E/-A` via `LogCultTrackDecreaseAction` (`server/internal/notation/parser.go`, `server/internal/notation/types.go`)
    - this keeps round-5 Cultists bowl state aligned (`0/2/4` before the line-305 leech) and removes the need for S60-S63 score overrides.
  - Added explicit regressions for cult-town selector semantics (`-<cult>`):
    - parser accepts multi-selector compounds like `-F.-W.-E.TW8VP` (`server/internal/notation/parser_test.go`)
    - conversion preserves up to three selectors for non-Cultists factions (`server/internal/notation/snellman_to_concise_test.go`)
    - replay execution coverage:
      - key-limited near-top scenario where three selectors intentionally leave only one track topping on `TW8VP`
        - test starts at `Keys=0` (town grants to `1`), so there is exactly one key available during cult advancement
      - selector+towntile rows fail if no pending town formation exists
      (`server/internal/notation/types_test.go`)
  - Verification after these changes:
    - `bazel --batch test //internal/replay:replay_test --test_output=errors` passed.
    - `bazel --batch test //internal/game:game_test --test_output=errors` passed.

- 2026-02-20 cult position-10 key semantics update:
  - `server/internal/game/cult.go` now consumes one key whenever a player newly reaches cult position `10`.
  - Position-10 checks now require key availability (`player.Keys`) with bounded key credit only from unclaimed, non-delayed pending towns (`CanBeDelayed=false`), so delayed Mermaids pending towns do not grant credit.
  - `server/internal/game/state.go` `SelectTownTile` now removes the pending town before `FormTown` benefits are applied, preventing the same town from being counted as both pending key credit and granted key during `+TW` resolution.
  - Added coverage in `server/internal/game/cult_test.go`:
    - reaching 10 consumes key,
    - delayed pending town does not allow topping,
    - immediate pending town can borrow one key (temporary `Keys=-1` debt until town key gain),
    - `TW8` with one available key tops only one track.

- 2026-02-21 multiplayer planning notes:
  - User requested a first-pass, detailed spec to build a live multiplayer Terra Mystica mode (2-5 players) by reusing replay infrastructure, with Snellman-style faction selection (no auction) and 20 VP starts.
  - Required interaction surface includes: setup dwelling/bonus selection, priest spot clicks, leech accept/decline modal, transform/build modal flows, upgrade branch modal, conversions, favor/town selection, power/special actions (including split spades and bridges), pass confirmations, cultists track selection, and cult spades (post-confirm undo removed by later clarification lock).
  - Current repo gap identified: websocket action routing is currently limited to `select_faction` + `setup_dwelling`; client action service and many UI controls are not yet wired for live actions.
  - Detailed implementation spec added at repository root: `MULTIPLAYER_TM_SPEC.md`.
- 2026-02-21 clarification lock for multiplayer spec:
  - no-auction v1 confirmed; 20 VP starts.
  - setup order default random but host-configurable; setup implementation must follow strict base rules, with strict reverse bonus-card pick order.
  - base map only for v1; `shipping-bonus` + `temple-scoring-tile` on by default.
  - resign/drop handling deferred.
  - Engineers bridge special rendered as square in SH-action location and counts as main action; Mermaids connect does not consume main action; both reusable whenever legal.
  - conversions only on active player's own turn.
  - spade followups must resolve sequentially.
  - no post-confirm undo in v1.
  - reconnect should auto-restore seat by token/session identity.
  - spectators and timers deferred to roadmap doc: `MULTIPLAYER_TODO_LATER.md`.

- 2026-02-21 multiplayer implementation update (backend milestone pass):
  - Bazel workspace root is `/Users/kevin/projects/tm_server/server` (not repo root). Use Bazel commands from there.
  - Implemented room-scoped websocket broadcasting and client game-room subscriptions in `server/internal/websocket/hub.go`.
  - Added seat binding per websocket connection/game in `server/internal/websocket/client.go`; `perform_action` now requires an in-game seat and uses seat identity instead of trusting payload `playerID`.
  - Added revision/idempotency execution path in `server/internal/game/manager.go`:
    - per-game `revision`,
    - `ExecuteActionWithMeta` with `expectedRevision` check,
    - `actionId` de-duplication,
    - `RevisionMismatchError` for stale actions.
  - Expanded websocket action routing to most engine actions (`select_faction`, setup actions, transform/build, upgrades, shipping/digging, priest send, power/special actions, pass, leech, favor/town, halflings, darklings, cultists, conversions, burn).
  - Added strict setup sequencing in `server/internal/game/state.go`:
    - dwelling queue with Chaos/Nomads rules,
    - reverse bonus-card setup picks,
    - setup completion transition to round-1 income then action phase.
  - Added new game actions:
    - `SetupBonusCardAction` (`action_setup_bonus_card.go`),
    - `SelectTownTileAction` (`action_select_town_tile.go`),
    - free `ConversionAction` + `BurnPowerAction` (`action_conversion.go`).
  - Pending decision serialization now includes pending state objects and normalized `pendingDecision` in `SerializeStateWithRevision`.
  - Leech flow update: `HasPendingActions` now blocks turn advancement while leech offers exist; when leech queue resolves, turn advances from leech action handler.
  - Random bonus-card setup selection now truly shuffles (`math/rand` seeded) in `server/internal/game/bonus_cards.go`.
  - Client updates:
    - `client/src/services/actionService.ts` now sends `actionId` + `expectedRevision` and canonical `params` payload.
    - `client/src/types/game.types.ts` includes `revision` and pending fields.
    - `client/src/components/Lobby.tsx` includes `randomizeTurnOrder` start option and sends it in `start_game` payload.
    - `client/src/components/Game.tsx` includes `playerID` in `get_game_state` payload for seat rebind on reconnect.
  - Validation run:
    - `bazel test //internal/game:game_test` (from `server/`) passed.
    - `bazel build //cmd/server:server` (from `server/`) passed.
    - `npm run type-check` (from `client/`) passed.
  - Follow-up gap after this pass:
    - frontend still needs UI flow wiring for composing nested `firstAction`/`secondAction` payloads for Chaos Magicians double-turn (`special_action_use` supports it server-side now).

- 2026-02-21 external data collection note (BGA Terra Mystica stats):
  - Public BGA pages accessible without auth:
    - `/playerstat?id=93627000&game=1118` (summary shell + premium-masked profile stats),
    - `/table?table=<id>` and `/12/terramystica?table=<id>` (open-graph style rank/score snippets).
  - All useful structured history/result endpoints tested require authenticated session (`code=806 Invalid session information`), including:
    - `/gamestats?...`,
    - `/message/board`,
    - `/table/table/tableinfos.html`,
    - `/table/table/tableratingsupdate.html`,
    - `/archive/archive/logs.html`.
  - Practical implication: automated collection of per-game arena/faction outcomes must run from an authenticated browser session (or with exported authenticated HTML/API payloads).

- 2026-02-21 external data collection correction (BGA Terra Mystica):
  - Public visitor sessions can call some AJAX endpoints if both are provided from a page bootstrap:
    - `PHPSESSID` cookie
    - `X-Request-Token` from page JS (`bgaConfig.requestToken`, single-quoted in current HTML).
  - Working endpoints with visitor token+cookie:
    - `POST /gamestats/gamestats/getGames.html` (paginated TM game rows, including `arena_win` marker),
    - `POST /table/table/tableinfos.html` (table result payload).
  - Gamestats pagination behavior observed:
    - initial load: `updateStats=1`,
    - “see more”: `updateStats=0&page=N`,
    - `page=1` duplicates initial page; next page starts at `page=2`.
  - Limitation still blocking faction extraction in visitor mode:
    - `tableinfos.result.stats.player.player_faction.values[*]` returns `*masked*` when `pma=false` (non-premium visitor), so per-player faction picks cannot be recovered anonymously.
  - Browser-side helper script for logged-in collection is now in:
    - `scripts/bga_tm_arena_faction_stats_browser.js`
    - Supports configurable date range via `startDateStr` / `endDateStr` (UTC, YYYY-MM-DD), default start `2026-01-13`, no default end.

- 2026-02-21 multiplayer implementation update (frontend+engineers bridge pass):
  - Added Engineers reusable stronghold bridge main action to engine:
    - `server/internal/game/action_engineers_bridge.go`
    - websocket route: `perform_action.type = "engineers_bridge"` in `server/internal/websocket/client.go`
    - tests: `server/internal/game/action_engineers_bridge_test.go`
  - Added client enum support for Mermaids connect action (`SpecialActionType.MermaidsRiverTown = 10`) in `client/src/types/game.types.ts`.
  - `client/src/components/Game.tsx` now wires:
    - setup-dwelling click flow during setup dwellings subphase,
    - pending free spades and pending cult-reward spades hex-action flows,
    - burn/ship/dig action confirmations,
    - Engineers bridge action mode + Mermaids connect target mode,
    - pass warning when optional specials/spades are still available.
  - `client/src/components/GameBoard/PlayerBoards.tsx` now includes:
    - conversion/burn buttons,
    - +Ship/+Dig controls,
    - Engineers and Mermaids square special-action controls in SH-action slot area.
  - `client/src/components/GameBoard/HexGridCanvas.tsx` now supports bridge edge hit-testing and emits bridge endpoint pairs through `onBridgeEdgeClick`.
  - `client/src/components/Game.tsx` now includes a Chaos Magicians double-turn authoring modal that submits nested `firstAction`/`secondAction` payloads.
  - Current known v1 gap after this pass:
    - strict sequential split-resolution controls for double-spade/halflings multi-spade “throw away remaining spade” UX are still incomplete,
    - town cult-top disambiguation (`town_cult_top_choice`) serialization/UI path is not yet implemented.
  - Validation after this pass:
    - `npm run type-check` (client) passed.
    - `bazel test //internal/game:game_test //internal/websocket:websocket_test` (server) passed.
    - `bazel build //cmd/server:server` (server) passed.

- 2026-02-21 multiplayer implementation update (town-cult + E2E + split spade follow-up):
  - Added key-limited town-cult-top follow-up end-to-end:
    - backend action `ActionSelectTownCultTop` and pending state in `server/internal/game/*`
    - websocket route `perform_action.type = "select_town_cult_top"`
    - frontend modal flow in `client/src/components/Game.tsx`
  - Added websocket integration E2E test covering setup->action progression and turn-authority rejection:
    - `server/internal/websocket/e2e_integration_test.go`
  - Fixed setup bonus-card availability handling:
    - backend manager validation no longer incorrectly rejects `setup_bonus_card`
    - frontend now treats bonus-card availability by key presence (not coin count > 0), so 0-coin legal cards remain selectable.
  - Added strict split-spade follow-up for ACT6:
    - leftover free spade is now persisted as pending follow-up (`PendingSpades`)
    - `PendingSpadeBuildAllowed` enforces “at most one dwelling across ACT6 split transforms”
    - new action `discard_pending_spade` (backend + websocket parser + client button) to support legal throwaway of remaining spade
    - manager turn/pending validation now blocks unrelated actions while pending spade/cult-reward-spade follow-ups exist.
  - Replay compatibility preserved while keeping strict multiplayer setup:
    - `SetupDwellingAction` now supports strict setup queue when initialized, and replay-compatible legacy setup execution when turn order is not yet known.
  - Deferred roadmap updated per user request:
    - `MULTIPLAYER_TODO_LATER.md` includes “Implement both regular auction and fast auction setup variants.”
  - Validation after this pass:
    - `bazel test //internal/game:game_test //internal/websocket:websocket_test //internal/replay:replay_test` passed.
    - `bazel test //...` passed.
    - `npm run type-check && npm run build` passed.

- 2026-02-21 multiplayer implementation finalization (Milestone G complete):
  - Hardened websocket E2E integration tests in `server/internal/websocket/e2e_integration_test.go`:
    - setup helper now drains creator `lobby_state` right after `game_created` to avoid create/join broadcast race in tests.
    - reconnect path now waits via `readUntilStateRevisionAtLeast(...)` to avoid stale `game_state_update` reads.
    - soak loop now refreshes state when current player is already passed and exits early when all players are passed.
    - soak assertions are now deterministic for base rules: require reconnect churn plus at least one full-table pass cycle.
    - added helper utilities `asBool(...)` and `allPlayersPassed(...)` for state guards.
  - Added websocket contract/soak coverage:
    - `TestWebsocketContract_SpadeFollowupAndDiscard`
    - `TestWebsocketSoak_FivePlayers_ReconnectChurn`
  - Frontend UX polish completed in `client/src/components/Game.tsx`:
    - Chaos double-turn parameter templates + JSON validation states for both action params.
    - clear pending spade/cult-spade banner copy for follow-up-required turns.
  - Spec/doc status:
    - `MULTIPLAYER_TM_SPEC.md` Milestone G moved to Completed and completion/validation section updated.
    - Deferred roadmap still in `MULTIPLAYER_TODO_LATER.md`, including requested future item: regular and fast auction setup variants.
  - Final validation matrix:
    - `bazel test //internal/websocket:websocket_test //internal/game:game_test //internal/replay:replay_test` (from `server/`) passed.
    - `bazel test //...` (from `server/`) passed.
    - `npm run type-check && npm run build` (from `client/`) passed.

- 2026-02-21 multiplayer E2E planning target (Snellman full-game):
  - Target game: `https://terra.snellman.net/faction/4pLeague_S69_D1L1_G2` (also present as fixture `server/internal/replay/testdata/snellman_batch/4pLeague_S69_D1L1_G2.txt`).
  - Confirmed expected final totals from Snellman view-game API and local manifest:
    - Nomads (RA): 166
    - Darklings (tom8918): 137
    - Mermaids (Gewalf): 130
    - Witches (Fujiwara): 124
  - Suggested full validation architecture:
    - use replay parser/simulator as oracle for step-by-step expected state,
    - drive multiplayer websocket/UI actions from the same action stream,
    - compare normalized state after each action and assert final scores at game end.
  - Practical coverage note: this single game covers many core interactions (setup, leech accept/decline, conversions, power actions, cult spades, upgrades, favors/towns, pass), but not all faction-specific branches (e.g. Engineers bridge, Halflings split-spade, Cultists selection).

- 2026-02-21 docs/roadmap update request:
  - User requested commit of all realtime multiplayer work completed so far, with spec expanded to include detailed golden end-to-end validation design for Snellman `4pLeague_S69_D1L1_G2`.
  - Added deferred roadmap items in `MULTIPLAYER_TODO_LATER.md`:
    - create login/auth system,
    - add more golden full-game fixtures for stronger coverage.

- 2026-02-21 BGA browser stats script update (`scripts/bga_tm_arena_faction_stats_browser.js`):
  - Replaced older single-player script with batch collector using hardcoded Terra Mystica season IDs (from Hall of Fame DOM).
  - Supports date-range config (`startDateStr`, optional `endDateStr`), arena-only filtering, and cross-player game dedupe by `table_id`.
  - Added conservative request throttling controls (`requestDelayMs`, `parallelism`) to reduce request burst rate.
  - Added per-faction aggregates for tracked players: frequency, placement counts, average rank, average starting VP, average total VP awarded, average total VP gained, average total points scored.
  - Added per-faction population standard deviation for total points scored (`stddevTotalPointsScored`).
  - CSV helpers now include robust download behavior plus an on-page fallback link if the browser blocks automatic download:
    - `downloadTmBatchFactionSummaryCsv()`
    - `downloadTmBatchFactionRecordsCsv()`
- 2026-02-21 BGA batch browser stats robustness + tie handling:
  - `scripts/bga_tm_arena_faction_stats_browser.js` now parses `tableinfos` player/stat payloads defensively across object-keyed and array-indexed shapes (including alternate player id fields like `player_id`/`userid`).
  - Added score/rank normalization fallback behavior so batch extraction aligns with single-game validation output.
  - `avgPlacement` now uses mid-rank tie handling by score (examples: tie for 1st => 1.5 each; tie for 2nd => 2.5 each; three-way tie for 1st/2nd/3rd => 2.0 each).
  - Rank buckets (`first`/`second`/`third`/`fourth`) continue using raw rank values, and records now include both `rank_raw` and `rank_for_average` in CSV exports.
- 2026-02-21 BGA batch aggregation scope change:
  - Game discovery still uses the hardcoded 70-player seed list, but aggregation now defaults to all players present in matched games (`includeAllPlayersFromMatchedGames: true`) so faction placement stats are global for those tables rather than only from tracked-player perspective.
  - Table rank extraction now also falls back to `tableinfos.result.player[*].rank` when gamestats rank list is missing/incomplete.
  - Records include `isTrackedPlayer` to allow optional filtering back to seed-list participants in downstream analysis.
- 2026-02-21 BGA CSV download reliability fix:
  - In-page fallback links were being intercepted by BGA navigation handlers, so CSV downloads could appear to do nothing.
  - `triggerCsvDownload` now prefers `showSaveFilePicker` (when available) and otherwise opens a blob URL in a new tab plus a secondary `download` attempt.
  - Added globals for manual recovery if popups/downloads are blocked: `tmLastCsvBlobUrl` and `tmOpenLastCsvBlobUrl()`.
- 2026-02-21 BGA abandoned-game filter:
  - Added batch filter to drop entire tables where every player's final score is exactly 0 or 1 (`excludeAllZeroOrOneFinalScoreGames: true`).
  - Exposed filter diagnostics in result payload:
    - `discoveredUniqueGames`
    - `filteredOutAllZeroOrOneGames`
    - `uniqueGames` (post-filter)
    - `filteredAllZeroOrOneGameIds`
- 2026-02-21 BGA summary-column simplification:
  - Removed redundant summary outputs `averageRank` and `stddevTotalPointsScored` from `scripts/bga_tm_arena_faction_stats_browser.js`.
  - Removed corresponding CSV columns `average_rank` and `stddev_total_points_scored` from `downloadTmBatchFactionSummaryCsv()`.
  - Cleaned unused stddev accumulator/computation code path.

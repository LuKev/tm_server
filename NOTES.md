# Workspace Notes

- Replay pipeline clarification (updated 2026-02-10): replay ingestion is now content-format-driven in `server/internal/replay/manager.go` (`auto|concise|snellman|bga`) via `parseReplayLogContent`, not keyed on special `gameID` values.
- Concise notation remains the display/output format from parsed items (`notation.GenerateConciseLog(items)`), and is now also a first-class replay input format via strict parsing (`notation.ParseConciseLogStrict`).
- Legacy `gameID == "local"` replay path has been removed from runtime logic (`StartReplay`/`fetchLog`); do not add new code that depends on `local` IDs as a special case.
- Import path note: `ImportLog` converts raw HTML to text first (`notation.ParseBGAHTML` or Snellman equivalent), then normalizes through shared replay parsing; Snellman imports are persisted as canonical concise logs.
- Tech debt review target (2026-02-10): `server/internal/game/manager.go:123` (`SerializeState`) contains a large embedded agent-style comment block (`manager.go:208` onward) that should be removed/refactored; it adds noise and obscures bridge serialization behavior.
- Tech debt review target (2026-02-10): duplicate runtime logic exists in `server/internal/game/board/map.go` between `GetConnectedBuildingsIncludingBridges` and `GetConnectedBuildingsForMermaids` (shared BFS/neighbor expansion), making future network/town-rule changes easy to drift.
- Tech debt review target (2026-02-10): faction structs have repeated `hasStronghold` fields, many write-only in production (e.g. `alchemists.go`, `nomads.go`, `witches.go`), while stronghold gating mostly uses `Player.HasStrongholdAbility`; consolidate source of truth.
- Replay roadmap request (2026-02-10): add two features using concise notation as a first-class replay input format: (1) Snellman bookmarklet import should convert Snellman ledger -> concise -> replay execution, and (2) UI should allow user-pasted concise logs for replay. Current gap: `ReplayManager.ImportLog` parses Snellman HTML to tab text but `StartReplay` still routes non-`local` sessions through `notation.NewBGAParser(...).Parse()`, so Snellman conversion logic is not part of the execution path yet.
- Replay ingestion refactor (2026-02-10): `ReplayManager` now parses by content format (`auto|concise|snellman|bga`) via `parseReplayLogContent`, with concise parsing done through `notation.ParseConciseLogStrict` (line/column-aware errors). `gameID == "local"` branches were removed from `StartReplay` and `fetchLog`.
- Import endpoints (2026-02-10): added text import flow `POST /api/replay/import_text` -> `ReplayManager.ImportText`, and Snellman HTML import now stores canonical concise text after conversion before replay start.
- Concise parser compatibility (2026-02-10): `notation.parseActionCode` now supports `ACT-BON-*`, `ACT-TOWN-*`, `ACT-BR-*`, and cult shorthand `+F/+W/+E/+A` (mapped to `LogCultistAdvanceAction`), preventing dropped compound actions from Snellman-converted logs.
- Bazel dependency note (2026-02-10): Bazel toolchain runs Go 1.21, so `github.com/PuerkitoBio/goquery` must stay on a Go-1.21-compatible version in `server/deps.bzl` (`v1.8.1`), not `v1.11.0` (which requires Go 1.24).
- Tech debt cleanup applied (2026-02-10): consolidated connected-building traversal in `server/internal/game/board/map.go` behind shared helper `getConnectedBuildings(..., allowMermaidRiverSkip)` plus `getBuildingTraversalNeighbors`, so bridge traversal and Mermaids town river-skip no longer drift across duplicate BFS implementations.
- Tech debt cleanup applied (2026-02-10): removed duplicate building power mapping from `server/internal/game/actions.go` (`getNewPowerValue`) and now consistently uses `GetPowerValue` from `server/internal/game/town.go` (unknown defaults to `0`).
- Tech debt cleanup applied (2026-02-10): removed unused faction interface/default methods `CanUseSpecialAction` and `ExecuteSpecialAction` from `server/internal/game/factions/faction.go` (no production call sites).
- Tech debt cleanup applied (2026-02-10): removed write-only `hasStronghold` fields from factions that never read them (`alchemists`, `auren`, `chaos_magicians`, `cultists`, `giants`, `mermaids`, `nomads`, `swarmlings`, `witches`); factions with runtime reads keep the field (`darklings`, `dwarves`, `engineers`, `fakirs`, `halflings`).
- Tech debt cleanup applied (2026-02-10): deduplicated accept/decline leech action flow in `server/internal/game/action_power_leech.go` via shared `validatePowerLeechOffer` and `executePowerLeechOffer` helpers; removed no-op `_ = 1` in Cultists bonus resolution.
- Git worktree gotcha (2026-02-10): if `git checkout main` fails with `already used by worktree at '/private/tmp/tm_server_main'`, `main` is checked out in a linked worktree. Inspect with `git worktree list` and free it with `git worktree remove /private/tmp/tm_server_main` (safe when clean).
- Snellman import parser detail (2026-02-10): setup lines like `Round X scoring: SCOREn` and `Removing tile BONn` may be rendered in `<th colspan>` rows with trailing `show history`; `ParseSnellmanHTML` now reads both `th`/`td`, strips `show history`, and `ConvertSnellmanToConcise` parses scoring/removed-bonus lines case-insensitively so imported Snellman logs populate `ScoringTiles`/`BonusCards` and avoid false "Missing Game Information" prompts.
- Snellman replay ID-casing gotcha (2026-02-10): `TurnOrder` emitted for rounds must use the same canonical casing as `StartingVPs`/grid player IDs (e.g. `Cultists`, not `cultists`), otherwise replay turn order can reference non-existent players after setup and the client may crash in cult-track rendering (`players[playerId]` undefined). Converter now formats round turn order via `formatFactionList(...)`, and frontend cult-position utility defensively skips missing players.
- Snellman setup-header variant parsing (2026-02-10): converter now accepts broader setup phrases for tiles (`Round N scoring ...` with or without `scoring:` and `Removing bonus tile BONn`), so imported logs from alternate Snellman wording still populate `ScoringTiles`/`BonusCards`.
- Snellman compound-action parsing (2026-02-10): when a single command chain includes conversions plus a main action keyword (e.g. `burn 3. convert 5PW to 1P. advance ship`), converter must preserve `advance ship`/`advance dig` as `+SHIP`/`+DIG` inside the same compound token; dropping it can produce invalid replay actions (`BURN...C...` without a legal main action).
- Concise parser strictness edge case (2026-02-11): standalone conversions (e.g. `C5PW:1P`) are intentionally rejected at top-level, but conversion segments inside compounds (e.g. `BURN3.C5PW:1P.+SHIP`) must still parse; enforce legality at compound execution (`no legal main action`) rather than rejecting compound subparts during recursive token parsing.
- Snellman extraction gotcha (2026-02-11): `extractSnellmanAction` must include `send p to` in its action-keyword regex; otherwise mixed commands like `send p to AIR. convert 1PW to 1C` get truncated to `convert ...`, leading to invalid standalone `C...` tokens in concise output. `convertActionToConcise` also needs to treat dotted `send p to ...` commands as compounds, not standalone send-priest actions.
- Snellman resource normalization (2026-02-11): conversion resources may appear as bare units in source logs (`convert 3pw to w`). Converter must normalize bare units to explicit counts (`1W`, `1P`, `1C`, `1PW`, `1VP`) before emitting concise conversion tokens to avoid parser dropping reward/cost maps.
- Concise parser case resilience (2026-02-11): `parseActionCode` now normalizes keyword matching case-insensitively (e.g. `burn3.c5pw:1p.+ship`, lowercase `up-*/act*/pass-*`), and resource/building/terrain short-code parsers uppercase inputs before decoding to avoid capitalization-dependent parse failures.
- Compound parse precedence (2026-02-11): concise parser must split compound tokens before single-action prefix parsing; otherwise tokens like `PASS-BON-BB.+A` can be misparsed as one pass with unknown bonus card suffix instead of `PASS-BON-BB` + `+A`.
- Cultists delayed bonus anchoring (2026-02-11): standalone cult bonus rows (`+AIR`, etc.) after a leech acceptance should backtrack to the latest leech-source action row (`lastLeechSourceRow`) before falling back to `lastMainActionRow`, so bonuses attach to triggering builds/upgrades rather than a later pass token.
- Leech decline robustness (2026-02-11): concise `DL` now parses to `LogDeclineLeechAction` (tolerant/no-op when no pending offer exists), aligning with existing tolerant `L` behavior and preventing hard replay stops when Snellman-derived decline rows arrive after reconstructed leech state has already resolved.
- Snellman income-block gotcha (2026-02-11): some logs place real actions between two `Round X income` headers (e.g. S69 has `transform I10 to green` between `cult_income_for_faction` rows and the next `Round 6 income`). The converter must only skip rows whose extracted action is `cult_income_for_faction` or `other_income_for_faction`; otherwise terrain transforms are dropped and later actions (like `ACTS-I10...`) replay against stale terrain.
- Final-scoring parity gap (2026-02-11): full S69 action replay now completes, but replay state VP totals at end of round 6 are still lower than Snellman finals (`Cultists 108`, `Engineers 125`, `Darklings 114`, `Witches 115` vs Snellman `148/147/143/119`). Indicates final scoring stages (cult/network/resources/other endgame scoring) are not being applied in this replay path.
- Leech VP cost correctness (2026-02-11): VP loss on leech acceptance must be computed from **actual power gained at accept time** (`max(gained-1,0)`), not the offer snapshot's `VPCost`. Pending offers can become stale after earlier accepts fill bowls; charging stale `VPCost` incorrectly subtracts VP when gain is 0/1.
- Replay leech tolerance edge case (2026-02-11): in replay execution only, ignore `DeclinePowerLeechAction` with `no pending leech offers` when the declining player is already power-full (`Bowl1=0` and `Bowl2=0`). This matches Snellman delayed-decline rows that appear after offers have already been resolved.
- Snellman 21-game fixture corpus (2026-02-11): deterministic replay fixtures for `S67..S69` (`G1..G7`) are generated by `scripts/fetch_snellman_batch.py` into `server/internal/replay/testdata/snellman_batch/` with a `manifest.json` containing expected final totals from Snellman.
- Batch certification test (2026-02-11): `server/internal/replay/snellman_batch_replay_test.go` runs `ImportText(..., \"snellman\") -> StartReplay -> JumpTo(end)` and asserts `state.FinalScoring[*].TotalVP` equals fixture expected totals for all 21 games.
- Legacy Snellman special-action normalization (2026-02-11): converter now maps `ACTC -> ACT-SH-2X`, `ACTE + bridge -> ACT-BR-<coord>-<coord>`, and `ACTS + upgrade <coord> to TP -> ACT-SH-TP-<coord>`; unit tests added in `server/internal/notation/snellman_to_concise_test.go`.
- Replay final-score parity update (2026-02-11): round-6 cleanup now syncs `Player.VictoryPoints` to finalized totals, and `CalculateFinalScoring()` returns existing `gs.FinalScoring` when already in `PhaseEnd` to avoid double-counting on recomputation.
- Snellman display-name gotcha (2026-02-11): converter must emit `Chaos Magicians` (with space) in `StartingVPs`/headers/turn order; naive title-casing of `chaosmagicians` causes unknown faction IDs and setup replay crashes.
- 21-game replay status after current fixes (2026-02-11): batch test still has 15 failures (resource insufficiency, power burn insufficiency, Mermaids town pending-formation mismatches, and isolated score mismatches). Keep the failing test as the red/green driver for subsequent replay-logic fixes.
- 2026-02-11 replay divergence follow-up:
  - Added replay compound execution recovery that pre-executes trailing `LogConversionAction`/`LogBurnAction` when an affordability error occurs on an earlier action in the same compound.
  - Changed `LogPowerAction` and `LogConversionAction` to stop implicit auto-burn from Bowl II; explicit `BURNn` rows are now authoritative.
  - Preserved delayed pending towns across round cleanup (`PendingTownFormations` now retains `CanBeDelayed` entries) to support Mermaids delayed town claims.
  - Reworked Mermaids connectivity search in `board/map.go` to evaluate all one-river-skip candidates and choose the best connected component by power/size instead of first-match skip.
  - Remaining failing certification buckets are mostly affordability/power sequencing mismatches in compound rows and small final VP mismatches (notably S67_G1, S67_G4, S67_G7, S68_G1).
